# Delta Twin - backend services

Platform for displaying the current status of the Delta Centre's study and research facility, utilizing real-time data from the building’s automation system and various deployed sensors.

**This project contains the source code for the backend services, including data querying functionalities and API.**  
Project containing the source code for the web application can be found [here.](https://github.com/thugoo/client-delta-twin)

API is available at http://172.17.89.249/api. Access requires a connection to the UT VPN.

<br>

## API endpoints
**/api/measurements** - Temperature and CO2 concentration measurements from Cumulocity IoT.

```
// Example of /api/measurements JSON structure

{
  "1018": {
    "qe_temperature": "22.3",
    "qe_temperature_time": "2024-05-01T08:14:00.000Z",
    "qe_co2": "430",
    "qe_co2_time": "2024-05-01T08:14:00.000Z"
  },
  "1004": {
    "qe_temperature": "21.8",
    "qe_temperature_time": "2024-05-01T08:14:00.000Z",
    "qe_co2": "442",
    "qe_co2_time": "2024-05-01T08:14:00.000Z"
  },
  // ... for each room that:
  //     * has device id and data type values mapped in 'mapping.json'
}
```

**/api/timetables_sis** - Timetable data from SIS.    

```
// Example of /api/timetables_sis JSON structure

{
  "1005": {
    "current_event":
      {
        "title": "Sotsiaalse ettevõtluse alused",
        "study_work_type": "lecture",
        "begin_time": "09:15",
        "end_time": "12:00"
      },
    "events": [
      {
        "title": "Sotsiaalse ettevõtluse alused",
        "study_work_type": "lecture",
        "begin_time": "09:15",
        "end_time": "12:00"
      },
      {
        "title": "Eraisiku rahandus",
        "study_work_type": "lecture",
        "begin_time": "16:15",
        "end_time": "18:00"
      }
    ]
  },
  // ... for each room with:
  //     * has 'timetable_events' value as true in 'mapping.json'
  //     * has its timetable data in SIS
}
```

**/api/timetables_deltaqr** - Timetable data from DeltaQR.

```
// Example of /api/timetables_deltaqr JSON structure

{
  "QR-I": {
    "current_event": {
      "title": null,
      "study_work_type": null,
      "begin_time": "18:30",
      "end_time": "22:00"
    },
    "events": [
      {
        "title": null,
        "study_work_type": null,
        "begin_time": "14:30",
        "end_time": "18:30"
      },
      {
        "title": null,
        "study_work_type": null,
        "begin_time": "09:00",
        "end_time": "11:00"
      },
      {
        "title": null,
        "study_work_type": null,
        "begin_time": "18:30",
        "end_time": "22:00"
      },
      {
        "title": null,
        "study_work_type": null,
        "begin_time": "12:30",
        "end_time": "14:30"
      }
    ]
  },
  // ... for each room with:
  //     * has 'timetable_events' value as true in 'mapping.json'
  //     * has its timetable data in DeltaQR
}
```

<br>

## Workflow flowchart

![Workflow](backend_flowchart.svg)

<br>

## Project structure
```
/
¦   ...
¦   auth.json                   // Access credentials for the Cumulocity IoT platform. Ignored by git.
¦   api.js                      // API service.
¦   docker-compose.yaml         // Defines services, networks, and volumes for all containers.
¦   Dockerfile                  // Defines the steps to build the Docker image for the main application.
¦   ...
¦   queryCumulocity.js          // Temperature and CO2 concentration measurements querying service.
¦   querySis.js                 // SIS timetable data querying service.
¦   queryDeltaqr.js             // DeltaQR imetable data querying service.
¦   README.md
¦   mappings.json                // Mappings between room numbers and various values.
¦   measurements.json           // Temperature and CO2 concentration measurements, generated by queryCumulocity.js.
¦   timetables_deltaqr.json     // DeltaQR timetable data, generated by queryDeltaqr.js. Ignored by git.
¦   timetables_sis.json         // SIS timetable data, generated by querySis.js. Ignored by git.
¦   backend_flowchart.svg       // Workflow flowchart of backend services.
```

<br>

## Deployment

The backend services utilize Docker for deployment

To build and start the container, follow these steps:

1. Open your terminal and navigate to the project directory.  
   
2. Create a file named "auth.json" with the following structure:  
```
// You need to insert the Delta Centre's Cumulocity IoT account information. Account must have read permissions.
{
    "domain": "https://delta.iot.cs.ut.ee",
    "username": username_here,
    "password": password_here
}
```
3. Ensure that the "clientUrl" value in \api.js matches the web application's URL.

4. Run the command `docker compose up --build` in your terminal.  

<br>

## License

This project is licensed under the MIT License. See the LICENSE file for details.
